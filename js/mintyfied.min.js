(function(c){var b=b||{};b.Post=Backbone.Model.extend({defaults:{id:"0",postUrl:"",type:"",notesUrl:"",reblogKey:""}});b.ModalPost=Backbone.Model.extend({defaults:_.extend(b.Post.prototype.defaults,{isVisible:!1,scrollToNotes:!1})});b.LoadMore=Backbone.Model.extend({defaults:{totalPages:0,page:1}});b.Posts=Backbone.Collection.extend({model:b.Post});b.PostsView=Backbone.View.extend({el:c(".posts"),initialize:function(){_.bindAll(this,"render","addPosts");this.collection=new b.Posts;var a=this.$el.find(".post");
this.addPosts(a);this.render(a)},render:function(a,c,b){this.$el.imagesLoaded(function(){c?this.isotope("appended",a,function(){b&&b()}):this.isotope({itemSelector:".post",transformsEnabled:!1,masonry:{columnWidth:280}},function(){b&&b()})})},addPosts:function(a,f){var d=this;f&&this.$el.append(a);_(a).each(function(a){a=c(a);var f=new b.Post({id:a.attr("data-post-id"),postUrl:a.attr("data-post-url"),type:a.attr("data-post-type"),notesUrl:a.attr("data-post-notesurl"),reblogKey:a.attr("data-post-reblogurl").split(a.attr("data-post-id")+
"/")[1]});d.collection.add(f);new b.PostView({el:a,model:f})})}});b.PostView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render");this.render()},events:{"click .modalLink":function(){g.model.set({id:this.model.get("id"),postUrl:this.model.get("postUrl"),type:this.model.get("type"),notesUrl:this.model.get("notesUrl"),isVisible:!0,scrollToNotes:!1});return!1},"click .noteCount":function(){g.model.set({id:this.model.get("id"),postUrl:this.model.get("postUrl"),type:this.model.get("type"),
notesUrl:this.model.get("notesUrl"),isVisible:!0,scrollToNotes:!0});return!1}},render:function(){this.$el.find("figcaption").canvasBackground();this.$el.find(".audioDesc").canvasBackground();this.$el.find(".permalink").tooltip({placement:"bottom"});if("audio"==this.model.get("type")&&!this.$el.find(".audio_player").get(0)){var a=this.model.get("postUrl").split(".tumblr.com")[0]+".tumblr.com/api/read/json",b=this.$el.find("#audio_player_"+this.model.get("id")),d=c("<div>Loading player...</div>").css({padding:"4px 9px"});
b.get(0)&&(b.html(d),c.ajax({url:a,data:{id:this.model.get("id")},dataType:"jsonp",success:function(a){a=c('<div class="audio_player"></div>').append(a.posts[0]["audio-player"]);b.html(a)},error:function(){b.html(d.html("Unable to load player"))}}))}}});b.ModalView=Backbone.View.extend({el:c(".modalScroll"),initialize:function(){_.bindAll(this,"showModal","hideModal");view=this;view.model=new b.ModalPost;view.model.on("change:isVisible",function(){view.model.get("isVisible")?view.showModal(view.model.get("scrollToNotes")):
view.hideModal()});c("#postModal").on("hidden",function(){view.model.set({isVisible:!1})});c(".modalScroll").click(function(){view.model.set({isVisible:!1})});c("#postModal").click(function(a){a.stopPropagation()})},showModal:function(a){var b=this.model;c(".modalPost").load(b.get("postUrl")+" article",function(){var d=c(this).find(".date");c(".modal-header h3").html(d.html());d.remove();c(".modalPostNotes").load(b.get("notesUrl"),function(){a&&c(".modalScroll").scrollTop(c(".modalPostNotes").position().top)});
c("#postModal").modal({show:!0,backdrop:!1});c(".modalScroll").show()})},hideModal:function(){c(".modalScroll").hide();c(".modalPost").html("");c(".modalPostNotes").html("");c("#postModal").modal("hide")}});b.LoadMoreView=Backbone.View.extend({el:c(".loadMore"),initialize:function(){_.bindAll(this,"loadMore");var a=this;a.$loadLink=a.$el.find(".load");a.model=new b.LoadMore({page:a.$el.attr("data-page"),totalPages:a.$el.attr("data-total-pages")});a.model.on("change:page",function(){a.$loadLink.attr("href",
"/page/"+(parseInt(a.model.get("page"))+1));this.get("page")==this.get("totalPages")&&a.$loadLink.hide()})},events:{"click .load":function(){var a=this.$el.find(".load");a.addClass("loading");this.loadMore(function(){a.removeClass("loading")});return!1}},loadMore:function(a){var b=this,d=parseInt(b.model.get("page"))+1;c.ajax({url:"/page/"+d,success:function(g){var e=c(g).find(".posts .post");e.css("opacity","0");h.addPosts(e,!0);h.render(e,!0,function(){b.model.set({page:d});e.css("opacity","1");
c("html, body").animate({scrollTop:e.position().top},500,"swing");a&&a()})},error:function(){location.href="/page/"+d}})}});b.HeaderView=Backbone.View.extend({el:c("#header"),initialize:function(){var a=this.$el.find(".icon");this.$el.find(".aboutMeDesc").collapse({toggle:!1}).on("hide",function(){a.removeClass("icon-chevron-up");a.addClass("icon-chevron-down")}).on("show",function(){a.removeClass("icon-chevron-down");a.addClass("icon-chevron-up")})}});var h=new b.PostsView,g=new b.ModalView;new b.LoadMoreView;
new b.HeaderView})(jQuery);