(function(b){var e=Backbone.Model.extend({defaults:{id:"0",postUrl:"",type:"",notesUrl:"",reblogKey:""}}),i=Backbone.Model.extend({defaults:_.extend(e.prototype.defaults,{isVisible:!1,scrollToNotes:!1})}),j=Backbone.Model.extend({defaults:{totalPages:0,page:1}}),k=Backbone.Collection.extend({model:e}),m=Backbone.View.extend({el:b(".posts"),initialize:function(){_.bindAll(this,"render","addPosts");this.collection=new k;var a=this.$el.find(".post");this.addPosts(a);this.render(a)},render:function(a,
b,c){this.$el.imagesLoaded(function(){b?this.isotope("appended",a,function(){c&&c()}):this.isotope({itemSelector:".post",transformsEnabled:!1,masonry:{columnWidth:280}},function(){c&&c()})})},addPosts:function(a,d){var c=this;d&&this.$el.append(a);_(a).each(function(a){var a=b(a),d=new e({id:a.attr("data-post-id"),postUrl:a.attr("data-post-url"),type:a.attr("data-post-type"),notesUrl:a.attr("data-post-notesurl"),reblogKey:a.attr("data-post-reblogurl").split(a.attr("data-post-id")+"/")[1]});c.collection.add(d);
new l({el:a,model:d})})}}),l=Backbone.View.extend({initialize:function(){_.bindAll(this,"render");this.render()},events:{"click .modalLink":function(){g.model.set({id:this.model.get("id"),postUrl:this.model.get("postUrl"),type:this.model.get("type"),notesUrl:this.model.get("notesUrl"),isVisible:!0,scrollToNotes:!1});return!1},"click .noteCount":function(){g.model.set({id:this.model.get("id"),postUrl:this.model.get("postUrl"),type:this.model.get("type"),notesUrl:this.model.get("notesUrl"),isVisible:!0,
scrollToNotes:!0});return!1}},render:function(){this.$el.find("figcaption").canvasBackground();this.$el.find(".audioDesc").canvasBackground();this.$el.find(".permalink").tooltip({placement:"bottom"});if("audio"==this.model.get("type")&&!this.$el.find(".audio_player").get(0)){var a=this.model.get("postUrl").split(".tumblr.com")[0]+".tumblr.com/api/read/json",d=this.$el.find("#audio_player_"+this.model.get("id")),c=b("<div>Loading player...</div>").css({padding:"4px 9px"});d.get(0)&&(d.html(c),b.ajax({url:a,
data:{id:this.model.get("id")},dataType:"jsonp",success:function(a){a=b('<div class="audio_player"></div>').append(a.posts[0]["audio-player"]);d.html(a)},error:function(){d.html(c.html("Unable to load player"))}}))}}}),n=Backbone.View.extend({el:b(".modalScroll"),initialize:function(){_.bindAll(this,"showModal","hideModal");view=this;view.model=new i;view.model.on("change:isVisible",function(){view.model.get("isVisible")?view.showModal(view.model.get("scrollToNotes")):view.hideModal()});b("#postModal").on("hidden",
function(){view.model.set({isVisible:!1})});b(".modalScroll").click(function(){view.model.set({isVisible:!1})});b("#postModal").click(function(a){a.stopPropagation()})},showModal:function(a){var d=this.model;b(".modalPost").load(d.get("postUrl")+" article",function(){var c=b(this).find(".date");b(".modal-header h3").html(c.html());c.remove();b(".modalPostNotes").load(d.get("notesUrl"),function(){a&&b(".modalScroll").scrollTop(b(".modalPostNotes").position().top)});b("#postModal").modal({show:!0,backdrop:!1});
b(".modalScroll").show()})},hideModal:function(){b(".modalScroll").hide();b(".modalPost").html("");b(".modalPostNotes").html("");b("#postModal").modal("hide")}}),o=Backbone.View.extend({el:b(".loadMore"),initialize:function(){_.bindAll(this,"loadMore");var a=this;a.$loadLink=a.$el.find(".load");a.model=new j({page:a.$el.attr("data-page"),totalPages:a.$el.attr("data-total-pages")});a.model.on("change:page",function(){a.$loadLink.attr("href","/page/"+(parseInt(a.model.get("page"))+1));this.get("page")==
this.get("totalPages")&&a.$loadLink.hide()})},events:{"click .load":function(){var a=this.$el.find(".load");a.addClass("loading");this.loadMore(function(){a.removeClass("loading")});return!1}},loadMore:function(a){var d=this,c=parseInt(d.model.get("page"))+1;b.ajax({url:"/page/"+c,success:function(e){var f=b(e).find(".posts .post");h.addPosts(f,!0);h.render(f,!0,function(){d.model.set({page:c});b("html, body").animate({scrollTop:f.position().top},500,"swing");a&&a()})},error:function(){location.href=
"/page/"+c}})}}),p=Backbone.View.extend({el:b("#header"),initialize:function(){var a=this.$el.find(".icon");this.$el.find(".aboutMeDesc").collapse({toggle:!1}).on("hide",function(){a.removeClass("icon-chevron-up");a.addClass("icon-chevron-down")}).on("show",function(){a.removeClass("icon-chevron-down");a.addClass("icon-chevron-up")})}}),h=new m,g=new n;new o;new p})(jQuery);